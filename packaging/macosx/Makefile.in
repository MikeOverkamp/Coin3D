# **************************************************************************
# Makefile
#
# Makefile for creating Mac OS X installers for the Coin binary SDK
# builds Coin and creates the following files:
#   Coin-$(VERSION).dmg         - DMG containing install packages
#   Coin-$(VERSION)-no_inst.dmg - DMG containing only Inventor.framework
#   coin.info                   - Fink package file
#
# Usage:
#   make VERSION=<coinversion> (e.g. make VERSION=2.1.0)
#
# Dependencies:
#   - Coin-$(VERSION).tar.gz must be placed in ../
#   - "libsimage.dylib" and "libfreetype.dylib" must be placed in 
#     supportlibs/lib
#
# Authors:
#   Marius Kintel <kintel@sim.no>
# **************************************************************************

#VERBOSE = -v

sdk_prefix = $(PWD)/install
framework_prefix = $(PWD)/framework
top_srcdir = @top_srcdir@
builddir = build-shared-release

COINDIST = Coin-$(VERSION).tar.gz
COIN = Coin-$(VERSION)
COINLIB = $(builddir)/src/libCoin.la
BUILDOPTIONS = --prefix=$(sdk_prefix) --with-framework-prefix=$(framework_prefix) --enable-threadsafe --disable-3ds-import --enable-optimization --disable-debug --disable-symbols

# **************************************************************************

all: $(COIN).dmg $(COIN)-no_inst.dmg coin.info

coin.info: ../$(COINDIST) coin.info.template
	@md5=`md5 ../$(COINDIST)`; \
	cat coin.info.template | sed -e "s/@md5sum@/$$md5/" > coin.info

$(COIN)-no_inst.dmg: $(COINLIB)
	@sh makenoinstdmg.sh $(VERBOSE) -f $(framework_prefix)/Inventor.framework -c $(COIN)

$(COIN).dmg: Coin.pkg CoinTools.pkg
	@sh makeinstdmg.sh $(VERBOSE) -c $(COIN)

Coin.pkg: $(COINLIB)
	@sh makecoinpkg.sh $(VERBOSE) -f $(framework_prefix)/Inventor.framework

CoinTools.pkg: $(COINLIB)
	@sh makecointoolspkg.sh $(VERBOSE) -r $(sdk_prefix)

# Configure, build and install Coin
# Includes a fix for changing the install name of the library
# to /Library/Framework/... and copying of libsimage and libfreetype
# to the correct location
$(COINLIB): ../$(COIN) supportlibs/lib/libsimage.dylib supportlibs/lib/libfreetype.dylib
	@if test -d $(builddir); then :; else mkdir $(builddir); fi
	@cd $(builddir); \
	../../$(COIN)/configure $(BUILDOPTIONS)
	@cd $(builddir); $(MAKE)
	@cd $(builddir); $(MAKE) install
	@touch $(COINLIB)
	@cd $(framework_prefix); \
	dylib=`find Inventor.framework -name "libCoin.dylib"`; \
	install_name_tool -id /Library/Frameworks/$$dylib $$dylib
	@cp supportlibs/lib/libsimage.dylib $(framework_prefix)/Inventor.framework/Versions/Current/Resources
	@cp supportlibs/lib/libfreetype.dylib $(framework_prefix)/Inventor.framework/Versions/Current/Resources
