# **************************************************************************
# Makefile
#
# Makefile for creating Mac OS X installers for the Coin binary SDK
# builds Coin and creates the following files:
#   Coin-@VERSION@.dmg         - DMG containing install packages
#   Coin-@VERSION@-no_inst.dmg - DMG containing only Inventor.framework
#   coin.info                   - Fink package file
#
# Usage:
#   make               - Makes release packages
#   make debug         - Makes release packages
#
# Dependencies:
#   - Coin-@VERSION@.tar.gz must be placed in ../
#   - "libsimage.dylib" and "libfreetype.dylib" must be placed in 
#     supportlibs/lib
#
# Authors:
#   Marius Kintel <kintel@sim.no>
# **************************************************************************

#VERBOSE = -v

top_srcdir = @top_srcdir@

COINDIST = Coin-@VERSION@.tar.gz
COIN = Coin-@VERSION@
supportlibs = supportlibs/lib/libsimage.dylib supportlibs/lib/libfreetype.dylib

# Default build type (overridden on cmd-line)
BUILDTYPE = release

ifeq ($(BUILDTYPE),release)
  builddir = $(PWD)/build-release
  BUILDOPTIONS = --enable-threadsafe --disable-3ds-import --enable-optimization --disable-debug --disable-symbosl --enable-shared --disable-static
  DMGSUFFIX = @MACOSX_NAME@
else
  builddir = $(PWD)/build-debug
  BUILDOPTIONS = --enable-threadsafe --disable-3ds-import --disable-optimization --enable-debug --enable-symbols --enable-shared --disable-static
  DMGSUFFIX = @MACOSX_NAME@-debug
endif

COINLIB = $(builddir)/src/libCoin.la
install_prefix = $(builddir)/install
cointools_prefix = $(install_prefix)/usr/local
framework_prefix = $(install_prefix)/Library/Frameworks

# **************************************************************************

all: $(COIN)-$(DMGSUFFIX).dmg $(COIN)-$(DMGSUFFIX)-no_inst.dmg coin.info

coin.info: coin.info.template
	@if test -f ../$(COINDIST); then \
	md5=`md5 -q ../$(COINDIST)`; \
	cat coin.info.template | sed -e "s/@md5sum@/$$md5/" > coin.info; \
	else \
	echo "Warning: ../$(COINDIST) not found, coin.info not generated."; \
	fi

#FIXME: Output name as parameter
$(COIN)-$(DMGSUFFIX)-no_inst.dmg: $(COINLIB)
	@sh makenoinstdmg.sh $(VERBOSE) -f $(framework_prefix)/Inventor.framework -c $(COIN)

#FIXME: Move *.pkg into builddir
$(COIN)-$(DMGSUFFIX).dmg: Coin.pkg CoinTools.pkg
	@sh makeinstdmg.sh $(VERBOSE) -c $(COIN)

Coin.pkg: $(COINLIB)
	@sh makecoinpkg.sh $(VERBOSE) -f $(framework_prefix)/Inventor.framework

CoinTools.pkg: $(COINLIB)
	@sh makecointoolspkg.sh $(VERBOSE) -r $(cointools_prefix)

# Configure, build and install Coin
# Includes copying of libsimage and libfreetype to the correct location
$(COINLIB): $(top_srcdir) $(supportlibs)
	@if test -d $(builddir); then :; else mkdir $(builddir); fi
	@cd $(builddir); \
	../$(top_srcdir)/configure $(BUILDOPTIONS)
	cd $(builddir); $(MAKE)
	cd $(builddir); $(MAKE) DESTDIR=$(install_prefix) install
	touch $(COINLIB)
	cp $(supportlibs) $(framework_prefix)/Inventor.framework/Versions/Current/Resources
